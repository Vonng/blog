{{/*
  Comments using Giscus
  Giscus is a comment system powered by GitHub Discussions.
  https://giscus.app/
*/}}

<div id="giscus-comments" class="mt-8">
  <script 
    src="https://giscus.app/client.js"
    data-repo="Vonng/blog"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMTQwNzczNjI="
    data-category="Announcements"
    data-category-id="DIC_kwDOBsyuss4CtpY7"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
</div>

<script>
  // 动态设置 Giscus 主题以匹配 Blowfish 主题
  function setGiscusTheme() {
    function getBlowfishTheme() {
      return document.documentElement.classList.contains("dark") ? "transparent_dark" : "light";
    }
    
    function updateGiscusTheme(theme) {
      const giscusFrame = document.querySelector('iframe[src*="giscus"]');
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage({
          giscus: {
            setConfig: {
              theme: theme
            }
          }
        }, 'https://giscus.app');
      }
    }
    
    // 设置初始主题
    const initialTheme = getBlowfishTheme();
    const giscusScript = document.querySelector('script[src*="giscus"]');
    if (giscusScript) {
      giscusScript.setAttribute('data-theme', initialTheme);
    }
    
    // 监听 DOM 变化以检测主题切换
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          const currentTheme = getBlowfishTheme();
          updateGiscusTheme(currentTheme);
        }
      });
    });
    
    // 开始观察 html 元素的 class 变化
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
    
    // 等待 Giscus 加载完成后设置正确的主题
    setTimeout(() => {
      updateGiscusTheme(initialTheme);
    }, 500);
    
    // 再次检查，确保主题正确设置
    setTimeout(() => {
      updateGiscusTheme(getBlowfishTheme());
    }, 1000);
  }
  
  // 页面加载完成后执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setGiscusTheme);
  } else {
    setGiscusTheme();
  }
</script>

<noscript>
  <div class="mt-8 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg">
    <p class="text-neutral-600 dark:text-neutral-400">
      Please enable JavaScript to view the comments powered by 
      <a href="https://giscus.app/" class="text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300">
        Giscus
      </a>.
    </p>
  </div>
</noscript>