{{ define "main" }}
  {{ .Scratch.Set "scope" "list" }}
  {{ $enableToc := .Params.showTableOfContents | default (site.Params.list.showTableOfContents | default false) }}
  {{ $showToc := and $enableToc (in .TableOfContents "<ul") }}

  {{/* Hero */}}
  {{ if site.Params.list.showHero | default false }}
    {{ $heroStyle := print "hero/" site.Params.list.heroStyle ".html" }}
    {{ if templates.Exists ( printf "partials/%s" $heroStyle ) }}
      {{ partial $heroStyle . }}
    {{ else }}
      {{ partial "hero/basic.html" . }}
    {{ end }}
  {{ end }}

  {{/* Section Hero Profile */}}
  {{ partial "section-hero.html" . }}

  {{/* Header */}}
  <header>
    {{ if .Params.showBreadcrumbs | default (site.Params.list.showBreadcrumbs | default false) }}
      {{ partial "breadcrumbs.html" . }}
    {{ end }}
    <div class="flex items-center justify-between mt-5">
      <h1 class="text-4xl font-extrabold text-neutral-900 dark:text-neutral">{{ .Title }}</h1>
      <div class="flex items-center gap-2">
        {{/* RSS Subscribe Button */}}
        {{ with .OutputFormats.Get "RSS" }}
          <a href="{{ .RelPermalink }}"
             class="p-1.5 text-neutral-100 hover:text-primary-400 transition-colors"
             title="{{ i18n "rss.subscribe" | default "Subscribe via RSS" }}"
             aria-label="{{ i18n "rss.subscribe" | default "Subscribe via RSS" }}">
            {{ partial "icon.html" "rss" }}
          </a>
        {{ end }}
        {{/* Layout Switch Button - only show for specific sections */}}
        {{ $showLayoutSwitch := .Params.showLayoutSwitch | default (site.Params.list.showLayoutSwitch | default false) }}
        {{ if $showLayoutSwitch }}
          <button
          id="layout-switch-btn"
          class="p-1.5 text-neutral-100 hover:text-white transition-colors"
          title="{{ i18n "layout.switch" | default "Switch layout" }}"
          aria-label="{{ i18n "layout.switch" | default "Switch layout" }}">
          <svg id="layout-icon-list" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
          <svg id="layout-icon-card" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
          </svg>
          <svg id="layout-icon-card-wide" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h14a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4z"/>
          </svg>
          </button>
        {{ end }}
      </div>
    </div>
    <div class="mt-1 mb-2 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      {{ partial "article-meta/list.html" (dict "context" . "scope" "single") }}
    </div>
    {{ $translations := .AllTranslations }}
    {{ with .File }}
      {{ $path := .Path }}
      {{ range $translations }}
        {{ $lang := print "."  .Lang  ".md" }}
        {{ $path = replace $path $lang ".md" }}
      {{ end }}
      {{ $jsPage := resources.Get "js/page.js" }}
      {{ $jsPage = $jsPage | resources.Minify | resources.Fingerprint (site.Params.fingerprintAlgorithm | default "sha512") }}
      <script
        type="text/javascript"
        src="{{ $jsPage.RelPermalink }}"
        integrity="{{ $jsPage.Data.Integrity }}"
        data-oid="views_{{ $path }}"
        data-oid-likes="likes_{{ $path }}"></script>
    {{ end }}
  </header>

  {{/* Description (markdown content) */}}
  {{ $tocMargin := cond $showToc "mt-12" "mt-0" }}
  {{ $topClass := cond (hasPrefix site.Params.header.layout "fixed") "lg:top-[140px]" "lg:top-10" }}
  <section class="{{ $tocMargin }} prose flex max-w-full flex-col dark:prose-invert lg:flex-row">
    {{ if $showToc }}
      <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
        <div class="toc ps-5 lg:sticky {{ $topClass }}">
          {{ partial "toc.html" . }}
        </div>
      </div>
    {{ end }}
    <div class="min-w-0 min-h-0 max-w-prose">
      {{ .Content }}
    </div>
  </section>

  {{/* Article Grid */}}
  {{ if gt .Pages 0 }}
    {{ $showLayoutSwitch := .Params.showLayoutSwitch | default false }}
    {{ $orderByWeight := .Params.orderByWeight | default (site.Params.list.orderByWeight | default false) }}
    {{ $groupByYear := .Params.groupByYear | default (site.Params.list.groupByYear | default false) }}
    {{ $groupByYear := and (not $orderByWeight) $groupByYear }}

    {{ if $showLayoutSwitch }}
      {{/* Layout Switchable View - Default to List View */}}

      {{/* List View (Default - visible) */}}
      <section id="layout-list" class="space-y-10 w-full">
        {{ if not $orderByWeight }}
          {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
            {{ if $groupByYear }}
              <h2 class="mt-12 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300">
                {{ .Key }}
              </h2>
            {{ end }}
            {{ range .Pages }}
              {{ partial "article-link/simple.html" . }}
            {{ end }}
          {{ end }}
        {{ else }}
          {{ range (.Paginate (.Pages.ByWeight)).Pages }}
            {{ partial "article-link/simple.html" . }}
          {{ end }}
        {{ end }}
      </section>

      {{/* Card View (hidden) */}}
      <section id="layout-card" class="hidden w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
        {{ if not $orderByWeight }}
          {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
            {{ range .Pages }}
              {{ partial "article-link/card.html" . }}
            {{ end }}
          {{ end }}
        {{ else }}
          {{ range (.Paginate (.Pages.ByWeight)).Pages }}
            {{ partial "article-link/card.html" . }}
          {{ end }}
        {{ end }}
      </section>

      {{/* Card View Wide (hidden) */}}
      <div id="layout-card-wide" class="hidden relative w-screen max-w-[1600px] px-[30px] start-[calc(max(-50vw,-800px)+50%)]">
        <section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
          {{ if not $orderByWeight }}
            {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
              {{ range .Pages }}
                {{ partial "article-link/card.html" . }}
              {{ end }}
            {{ end }}
          {{ else }}
            {{ range (.Paginate (.Pages.ByWeight)).Pages }}
              {{ partial "article-link/card.html" . }}
            {{ end }}
          {{ end }}
        </section>
      </div>

      {{/* Layout Switch JavaScript */}}
      <script>
      (function() {
        const layouts = ['list', 'card', 'card-wide'];
        const storageKey = 'blog-layout-preference';

        function getStoredLayout() {
          try {
            return localStorage.getItem(storageKey) || 'list';
          } catch (e) {
            return 'list';
          }
        }

        function setStoredLayout(layout) {
          try {
            localStorage.setItem(storageKey, layout);
          } catch (e) {}
        }

        function updateIcons(layout) {
          document.getElementById('layout-icon-list').classList.toggle('hidden', layout !== 'list');
          document.getElementById('layout-icon-card').classList.toggle('hidden', layout !== 'card');
          document.getElementById('layout-icon-card-wide').classList.toggle('hidden', layout !== 'card-wide');
        }

        function switchLayout(newLayout) {
          layouts.forEach(l => {
            const el = document.getElementById('layout-' + l);
            if (el) {
              el.classList.toggle('hidden', l !== newLayout);
            }
          });
          updateIcons(newLayout);
          setStoredLayout(newLayout);
        }

        function getNextLayout(current) {
          const idx = layouts.indexOf(current);
          return layouts[(idx + 1) % layouts.length];
        }

        document.addEventListener('DOMContentLoaded', function() {
          const btn = document.getElementById('layout-switch-btn');
          if (!btn) return;

          let currentLayout = getStoredLayout();
          switchLayout(currentLayout);

          btn.addEventListener('click', function(e) {
            e.preventDefault();
            currentLayout = getNextLayout(currentLayout);
            switchLayout(currentLayout);
          });
        });
      })();
      </script>

    {{ else }}
      {{/* Original non-switchable view */}}
      {{ $cardView := .Params.cardView | default (site.Params.list.cardView | default false) }}
      {{ $cardViewScreenWidth := .Params.cardViewScreenWidth | default (site.Params.list.cardViewScreenWidth | default false) }}

      {{ if not $cardView }}
        <section class="space-y-10 w-full">
          {{ if not $orderByWeight }}
            {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
              {{ if $groupByYear }}
                <h2 class="mt-12 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300">
                  {{ .Key }}
                </h2>
              {{ end }}
              {{ range .Pages }}
                {{ partial "article-link/simple.html" . }}
              {{ end }}
            {{ end }}
          {{ else }}
            {{ range (.Paginate (.Pages.ByWeight)).Pages }}
              {{ partial "article-link/simple.html" . }}
            {{ end }}
          {{ end }}
        </section>
      {{/* else: is cardView */}}
      {{ else }}
        {{ if $groupByYear }}
          {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
            {{ if $cardViewScreenWidth }}
              <div class="relative w-screen max-w-[1600px] px-[30px] start-[calc(max(-50vw,-800px)+50%)]">
                <h2 class="mt-12 mb-3 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300">
                  {{ .Key }}
                </h2>
                <section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
                  {{ range .Pages }}
                    {{ partial "article-link/card.html" . }}
                  {{ end }}
                </section>
              </div>
            {{ else }}
              <h2 class="mt-12 mb-3 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300">
                {{ .Key }}
              </h2>
              <section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
                {{ range .Pages }}
                  {{ partial "article-link/card.html" . }}
                {{ end }}
              </section>
            {{ end }}
          {{ end }}

        {{/* else: not groupByYear */}}
        {{ else }}
          {{ if $cardViewScreenWidth }}
            <div class="relative w-screen max-w-[1600px] px-[30px] start-[calc(max(-50vw,-800px)+50%)]">
              <section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
                {{ if not $orderByWeight }}
                  {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
                    {{ range .Pages }}
                      {{ partial "article-link/card.html" . }}
                    {{ end }}
                  {{ end }}
                {{ else }}
                  {{ range (.Paginate (.Pages.ByWeight)).Pages }}
                    {{ partial "article-link/card.html" . }}
                  {{ end }}
                {{ end }}
              </section>
            </div>
          {{ else }}
            <section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
              {{ if not $orderByWeight }}
                {{ range (.Paginate (.Pages.GroupByDate "2006")).PageGroups }}
                  {{ range .Pages }}
                    {{ partial "article-link/card.html" . }}
                  {{ end }}
                {{ end }}
              {{ else }}
                {{ range (.Paginate (.Pages.ByWeight)).Pages }}
                  {{ partial "article-link/card.html" . }}
                {{ end }}
              {{ end }}
            </section>
          {{ end }}{{/* End of cardViewScreenWidth */}}
        {{ end }}{{/* End of groupByYear */}}
      {{ end }}{{/* End of cardView */}}
    {{ end }}{{/* End of showLayoutSwitch */}}
  {{/* else: .Pages not greater to zero */}}
  {{ else }}
    <section class="mt-10 prose dark:prose-invert">
      <p class="py-8 border-t">
        <em>{{ i18n "list.no_articles" | emojify }}</em>
      </p>
    </section>
  {{ end }}
  {{ partial "pagination.html" . }}
{{ end }}
