---
title: "PostgreSQLçš„KPI"
linkTitle: "PostgreSQLçš„KPI"
date: 2020-05-29
author: |
  [å†¯è‹¥èˆª](https://vonng.com)ï¼ˆ[@Vonng](https://vonng.com/en/)ï¼‰ | [å¾®ä¿¡å…¬ä¼—å·](https://mp.weixin.qq.com/s/bG6KG7mmu4K7JMYMI34zCQ)
summary: >
  ç®¡æ•°æ®åº“å’Œç®¡äººå·®ä¸å¤šï¼Œéƒ½éœ€è¦å®šKPIï¼ˆå…³é”®æ€§èƒ½æŒ‡æ ‡ï¼‰ã€‚é‚£ä¹ˆæ•°æ®åº“çš„KPIæ˜¯ä»€ä¹ˆï¼Ÿæœ¬æ–‡ä»‹ç»äº†ä¸€ç§è¡¡é‡PostgreSQLè´Ÿè½½çš„æ–¹å¼ï¼šä½¿ç”¨ä¸€ç§å•ä¸€æ¨ªå‘å¯æ¯”ï¼Œä¸Žè´Ÿè½½ç±»åž‹å’Œæœºå™¨ç±»åž‹åŸºæœ¬æ— å…³çš„æŒ‡æ ‡ï¼Œåæ›°**PG Loadï¼ˆPGè´Ÿè½½ï¼‰**ã€‚
tags: [PostgreSQL,PGç®¡ç†,ç›‘æŽ§,æŒ‡æ ‡]
---


ç®¡æ•°æ®åº“å’Œç®¡äººå·®ä¸å¤šï¼Œéƒ½éœ€è¦å®šKPIï¼ˆå…³é”®æ€§èƒ½æŒ‡æ ‡ï¼‰ã€‚é‚£ä¹ˆæ•°æ®åº“çš„KPIæ˜¯ä»€ä¹ˆï¼Ÿæœ¬æ–‡ä»‹ç»äº†ä¸€ç§è¡¡é‡PostgreSQLè´Ÿè½½çš„æ–¹å¼ï¼šä½¿ç”¨ä¸€ç§å•ä¸€æ¨ªå‘å¯æ¯”ï¼Œä¸Žè´Ÿè½½ç±»åž‹å’Œæœºå™¨ç±»åž‹åŸºæœ¬æ— å…³çš„æŒ‡æ ‡ï¼Œåæ›°**PG Loadï¼ˆPGè´Ÿè½½ï¼‰**ã€‚

------

## 0x01 Introduction

åœ¨çŽ°å®žç”Ÿäº§ä¸­ï¼Œç»å¸¸ä¼šæœ‰è¡¡é‡æ•°æ®åº“æ€§èƒ½ä¸Žè´Ÿè½½ï¼Œè¯„ä¼°æ•°æ®åº“æ°´ä½çš„éœ€æ±‚ã€‚ä¸€ç§æœ€æœ´ç´ çš„å½¢å¼å°±æ˜¯ï¼Œèƒ½ä¸èƒ½æœ‰ä¸€ä¸ªç±»ä¼¼äºŽKPIçš„å•ä¸€æŒ‡æ ‡ï¼Œèƒ½ç›´æŽ¥äº†å½“åœ°å‘Šè¯‰ç”¨æˆ·ä»–å¿ƒçˆ±çš„æ•°æ®åº“è´Ÿè½½æœ‰æ²¡æœ‰è¶…è¿‡è­¦æˆ’çº¿ï¼Ÿå·¥ä½œé‡åˆ°åº•é¥±å’Œä¸é¥±å’Œï¼Ÿ

å½“ç„¶è¿™é‡Œå…¶å®žéšå«ç€ä¸€ä¸ªé‡è¦ä¿¡æ¯ï¼Œå³ç”¨æˆ·æœŸå¾…çš„è´Ÿè½½æŒ‡æ ‡æ˜¯ä¸€ä¸ª**é¥±å’Œåº¦ï¼ˆSaturationï¼‰**æŒ‡æ ‡ï¼Œæ‰€è°“é¥±å’Œåº¦ï¼Œå³æœåŠ¡å®¹é‡æœ‰å¤šâ€æ»¡â€œï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿä¸­ç›®å‰æœ€ä¸ºå—é™çš„æŸç§èµ„æºçš„æŸä¸ªå…·ä½“æŒ‡æ ‡çš„åº¦é‡ã€‚é€šå¸¸æ¥è¯´ï¼Œ0%çš„é¥±å’Œåº¦æ„å‘³ç€ç³»ç»Ÿå®Œå…¨ç©ºé—²ï¼Œ100%çš„é¥±å’Œåº¦æ„å‘³ç€æ»¡è½½ï¼Œç³»ç»Ÿåœ¨è¾¾åˆ°100%åˆ©ç”¨çŽ‡å‰å°±ä¼šå‡ºçŽ°æ€§èƒ½çš„ä¸¥é‡ä¸‹é™ï¼Œå› æ­¤è®¾å®šæŒ‡æ ‡æ—¶è¿˜éœ€è¦åŒ…æ‹¬ä¸€ä¸ª**åˆ©ç”¨çŽ‡ç›®æ ‡**ï¼Œæˆ–è€…è¯´**æ°´ä½çº¢çº¿ã€é»„çº¿**ï¼Œå½“ç³»ç»Ÿçž¬æ—¶è´Ÿè½½è¶…è¿‡çº¢çº¿æ—¶åº”å½“è§¦å‘å‘Šè­¦ï¼Œé•¿æœŸè´Ÿè½½è¶…è¿‡é»„çº¿æ—¶åº”å½“è¿›è¡Œæ‰©å®¹ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œå®šä¹‰ç³»ç»Ÿæœ‰å¤šâ€é¥±å’Œâ€œå¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œå¾€å¾€éœ€è¦å€ŸåŠ©æŸäº›é—´æŽ¥æŒ‡æ ‡ã€‚è¯„ä¼°ä¸€ä¸ªæ•°æ®åº“çš„è´Ÿè½½ç¨‹åº¦ï¼Œä¼ ç»Ÿä¸Šé€šå¸¸ä¼šåŸºäºŽè¿™æ ·å‡ ç±»æŒ‡æ ‡è¿›è¡Œç»¼åˆè¯„ä¼°ï¼š

* æµé‡ï¼šæ¯ç§’æŸ¥è¯¢æ•°é‡QPSï¼Œæˆ–æ¯ç§’äº‹åŠ¡æ•°é‡TPSã€‚
* å»¶è¿Ÿï¼šæŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´ Query RTï¼Œæˆ–äº‹åŠ¡å¹³å‡å“åº”æ—¶é—´Xact RT

* é¥±å’Œåº¦ï¼šæœºå™¨è´Ÿè½½ï¼ˆLoadï¼‰ï¼ŒCPUä½¿ç”¨çŽ‡ï¼Œç£ç›˜è¯»å†™å¸¦å®½é¥±å’Œåº¦ï¼Œç½‘å¡IOå¸¦å®½é¥±å’Œåº¦
* é”™è¯¯ï¼šæ•°æ®åº“å®¢æˆ·ç«¯è¿žæŽ¥æŽ’é˜Ÿ

è¿™äº›æŒ‡æ ‡å¯¹äºŽæ•°æ®åº“æ€§èƒ½è¯„ä¼°éƒ½å¾ˆæœ‰å‚è€ƒæ„ä¹‰ï¼Œä½†å®ƒä»¬ä¹Ÿéƒ½å­˜åœ¨å„å¼å„æ ·çš„é—®é¢˜ã€‚


------

## 0x02 å¸¸ç”¨è¯„ä¼°æŒ‡æ ‡çš„é—®é¢˜

è®©æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ï¼Œè¿™äº›çŽ°æœ‰çš„å¸¸ç”¨æŒ‡æ ‡éƒ½æœ‰å“ªäº›é—®é¢˜ã€‚

ç¬¬ä¸€ä¸ªPassçš„å½“ç„¶æ˜¯é”™è¯¯ç±»æŒ‡æ ‡ï¼Œè­¬å¦‚è¿žæŽ¥æ± æŽ’é˜Ÿã€‚é”™è¯¯ç±»æŒ‡æ ‡æœ€å¤§çš„é—®é¢˜å°±æ˜¯ï¼Œå½“é”™è¯¯å‡ºçŽ°æ—¶ï¼Œé¥±å’Œåº¦å¯èƒ½å·²ç»æ²¡æœ‰æ„ä¹‰äº†ã€‚**è¯„ä¼°é¥±å’Œåº¦çš„ä¸€ä¸ªé‡è¦åŽŸå› å°±æ˜¯ç”¨äºŽé¢„é˜²ç³»ç»Ÿè¿‡è½½ï¼Œå¦‚æžœç³»ç»Ÿå·²ç»è¿‡è½½å¤§é‡æŠ¥é”™ï¼Œé‚£ä¹ˆä½¿ç”¨é”™è¯¯çŽ°è±¡åè¿‡æ¥å®šä¹‰é¥±å’Œåº¦æ˜¯æ²¡æœ‰æ„ä¹‰çš„**ã€‚æ­¤å¤–ï¼Œé”™è¯¯ç±»æŒ‡æ ‡éš¾ä»¥ç²¾ç¡®é‡åŒ–ã€‚æˆ‘ä»¬åªèƒ½è¯´ï¼šå½“è¿žæŽ¥æ± å‡ºçŽ°æŽ’é˜Ÿæ—¶ï¼Œæ•°æ®åº“è´Ÿè½½æ¯”è¾ƒå¤§ï¼›é˜Ÿåˆ—è¶Šé•¿ï¼Œè´Ÿè½½è¶Šå¤§ï¼›æ²¡æœ‰æŽ’é˜Ÿæ—¶ï¼Œæ•°æ®åº“è´Ÿè½½ä¸æ€Žä¹ˆå¤§ï¼Œä»…æ­¤è€Œå·²ã€‚è¿™æ ·çš„å®šä¹‰å½“ç„¶ä¹Ÿæ— æ³•è®©äººæ»¡æ„ã€‚

ç¬¬äºŒä¸ªPassçš„åˆ™æ˜¯ç³»ç»Ÿå±‚ï¼ˆæœºå™¨çº§åˆ«ï¼‰æŒ‡æ ‡ï¼Œæ•°æ®åº“è¿è¡Œåœ¨æœºå™¨ä¸Šï¼ŒCPUä½¿ç”¨çŽ‡ï¼ŒIOä½¿ç”¨çŽ‡è¿™æ ·çš„æŒ‡æ ‡ä¸Žæ•°æ®åº“è´Ÿè½½ç¨‹åº¦å¯†åˆ‡ç›¸å…³ï¼Œ**å¦‚æžœCPUå’ŒIOæ˜¯ç“¶é¢ˆï¼Œç†è®ºä¸Šå½“ç„¶æ˜¯å¯ä»¥ç›´æŽ¥ä½¿ç”¨ç“¶é¢ˆèµ„æºçš„é¥±å’Œåº¦æŒ‡æ ‡**ä½œä¸ºæ•°æ®åº“çš„é¥±å’ŒæŒ‡æ ‡ï¼Œä½†è¿™ä¸€ç‚¹å¹¶éžæ€»æ˜¯æˆç«‹çš„ï¼Œæœ‰å¯èƒ½ç³»ç»Ÿç“¶é¢ˆåœ¨äºŽæ•°æ®åº“æœ¬èº«ã€‚è€Œä¸”ä¸¥æ ¼æ¥è¯´å®ƒä»¬æ˜¯æœºå™¨çš„KPIè€Œä¸æ˜¯DBçš„KPIï¼Œ**è¯„ä¼°æ•°æ®åº“è´Ÿè½½æ—¶å½“ç„¶å¯ä»¥å‚ç…§ç³»ç»Ÿå±‚çš„æŒ‡æ ‡ï¼Œä½†DBå±‚ä¹Ÿåº”è¯¥æœ‰æœ¬å±‚çš„è¯„ä¼°æŒ‡æ ‡**ã€‚è¦å…ˆæœ‰æ•°æ®åº“æœ¬èº«çš„é¥±å’Œåº¦æŒ‡æ ‡ï¼Œæ‰å¯ä»¥åŽ»æ¯”è¾ƒåº•å±‚èµ„æºå’Œæ•°æ®åº“æœ¬èº«åˆ°åº•è°å…ˆé¥±å’Œè°æ˜¯ç“¶é¢ˆã€‚è¿™æ¡åŽŸåˆ™åŒæ ·é€‚ç”¨äºŽåº”ç”¨å±‚è§‚å¯Ÿåˆ°çš„æŒ‡æ ‡ã€‚

æµé‡ç±»çš„æŒ‡æ ‡å¾ˆæœ‰æ½œåŠ›ï¼Œç‰¹åˆ«æ˜¯QPSï¼ŒTPSè¿™æ ·çš„æŒ‡æ ‡ç›¸å½“å…·æœ‰ä»£è¡¨æ€§ã€‚ä½†è¿™äº›æŒ‡æ ‡ä¹Ÿå­˜åœ¨é—®é¢˜ã€‚ä¸€ä¸ªæ•°æ®åº“å®žä¾‹ä¸Šçš„æŸ¥è¯¢å¾€å¾€æ˜¯äº”èŠ±å…«é—¨å„å¼å„æ ·çš„ï¼Œä¸€ä¸ªè€—æ—¶10å¾®ç§’çš„æŸ¥è¯¢å’Œä¸€ä¸ª10ç§’çš„æŸ¥è¯¢åœ¨ç»Ÿè®¡æ—¶éƒ½è¢«ç®—ä¸ºä¸€ä¸ªQï¼Œ**ç±»ä¼¼äºŽQPSè¿™æ ·çš„æŒ‡æ ‡æ— æ³•è¿›è¡Œæ¨ªå‘æ¯”è¾ƒï¼Œåªæœ‰æ¯”è¾ƒç²—ç•¥çš„å‚è€ƒæ„ä¹‰**ï¼Œç”šè‡³å½“æŸ¥è¯¢ç±»åž‹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéƒ½æ— æ³•å’Œè‡ªå·±çš„åŽ†å²æ•°æ®è¿›è¡Œçºµå‘æ¯”è¾ƒã€‚æ­¤å¤–ä¹Ÿå¾ˆéš¾é’ˆå¯¹QPSã€TPSè¿™æ ·çš„æŒ‡æ ‡è®¾ç½®åˆ©ç”¨çŽ‡ç›®æ ‡ï¼ŒåŒä¸€ä¸ªæ•°æ®åº“æ‰§è¡Œ`SELECT 1`å¯ä»¥æ‰“åˆ°å‡ åä¸‡çš„QPSï¼Œä½†æ‰§è¡Œå¤æ‚SQLæ—¶å¯èƒ½å°±åªèƒ½æ‰“åˆ°å‡ åƒçš„QPSã€‚ä¸åŒè´Ÿè½½ç±»åž‹å’Œæœºå™¨ç¡¬ä»¶ä¼šå¯¹æ•°æ®åº“çš„QPSä¸Šé™äº§ç”Ÿæ˜¾è‘—å½±å“ï¼Œåªæœ‰å½“ä¸€ä¸ªæ•°æ®åº“ä¸Šçš„æŸ¥è¯¢éƒ½æ˜¯é«˜åº¦å•ä¸€åŒè´¨ä¸”æ²¡æœ‰å¤æ‚å˜åŒ–çš„æ¡ä»¶ä¸‹ï¼ŒQPSæ‰æœ‰å‚è€ƒæ„ä¹‰ï¼Œåœ¨è¿™ç§è‹›åˆ»æ¡ä»¶ä¸‹å€’æ˜¯å¯ä»¥é€šè¿‡åŽ‹åŠ›æµ‹è¯•è®¾å®šä¸€ä¸ªQPSçš„æ°´ä½ç›®æ ‡ã€‚

æ¯”èµ·QPS/TPSï¼ŒRTï¼ˆå“åº”æ—¶é—´ Response Timeï¼‰è¿™æ ·çš„æŒ‡æ ‡åè€Œæ›´å…·æœ‰å‚è€ƒä»·å€¼ã€‚å› ä¸ºå“åº”æ—¶é—´å¢žåŠ å¾€å¾€æ˜¯ç³»ç»Ÿé¥±å’Œçš„å‰å…†ã€‚æ ¹æ®ç»éªŒæ³•åˆ™ï¼Œæ•°æ®åº“çš„è´Ÿè½½è¶Šå¤§ï¼ŒæŸ¥è¯¢ä¸Žäº‹åŠ¡çš„å¹³å‡å“åº”æ—¶é—´ä¹Ÿä¼šè¶Šé«˜ã€‚RTç›¸æ¯”QPSçš„ä¸€ä¸ªä¼˜åŠ¿æ˜¯**ï¼ŒRTæ˜¯å¯ä»¥è®¾ç½®ä¸€ä¸ªåˆ©ç”¨çŽ‡ç›®æ ‡çš„**ï¼Œæ¯”å¦‚å¯ä»¥ä¸ºRTè®¾å®šä¸€ä¸ªç»å¯¹é˜ˆå€¼ï¼šä¸å…è®¸ç”Ÿäº§OLTPåº“ä¸Šå‡ºçŽ°RTè¶…è¿‡1msçš„æ…¢æŸ¥è¯¢ã€‚ä½†QPSè¿™æ ·çš„æŒ‡æ ‡å°±å¾ˆéš¾ç”»å‡ºçº¢çº¿æ¥ã€‚ä¸è¿‡ï¼ŒRTä¹Ÿæœ‰è‡ªå·±çš„é—®é¢˜ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒä¾ç„¶æ˜¯å®šæ€§è€Œéžå®šé‡çš„ï¼Œå»¶è¿Ÿå¢žåŠ åªæ˜¯ç³»ç»Ÿé¥±å’Œçš„é¢„è­¦ï¼Œä½†æ²¡æ³•ç”¨æ¥ç²¾ç¡®è¡¡é‡ç³»ç»Ÿçš„é¥±å’Œåº¦ã€‚ç¬¬äºŒä¸ªé—®é¢˜é€šå¸¸èƒ½ä»Žæ•°æ®åº“ä¸Žä¸­é—´ä»¶èŽ·å–åˆ°çš„RTç»Ÿè®¡æŒ‡æ ‡éƒ½æ˜¯å¹³å‡å€¼ï¼Œä½†çœŸæ­£èµ·åˆ°é¢„è­¦æ•ˆæžœçš„æœ‰å¯èƒ½æ˜¯è¯¸å¦‚P99ï¼ŒP999è¿™æ ·çš„ç»Ÿè®¡é‡ã€‚

è¿™é‡ŒæŠŠå¸¸ç”¨æŒ‡æ ‡éƒ½æ‰¹åˆ¤äº†ä¸€ç•ªï¼Œåˆ°åº•ä»€ä¹ˆæ ·çš„æŒ‡æ ‡é€‚åˆä½œä¸ºæ•°æ®åº“æœ¬èº«çš„é¥±å’Œåº¦å‘¢ï¼Ÿ


------

## 0x03 è¡¡é‡PGçš„è´Ÿè½½

æˆ‘ä»¬ä¸å¦¨å‚è€ƒä¸€ä¸‹**æœºå™¨è´Ÿè½½ï¼ˆNode Loadï¼‰**å’Œ**CPUåˆ©ç”¨çŽ‡ï¼ˆCPU Utilizationï¼‰**çš„è¯„ä¼°æŒ‡æ ‡æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚

### æœºå™¨è´Ÿè½½ï¼ˆNode Loadï¼‰

æƒ³è¦çœ‹åˆ°æœºå™¨çš„è´Ÿè½½æ°´å¹³ï¼Œå¯ä»¥åœ¨Linuxç³»ç»Ÿä¸­ä½¿ç”¨`top`å‘½ä»¤ã€‚`top`å‘½ä»¤çš„ç¬¬ä¸€è¡Œè¾“å‡ºå°±é†’ç›®åœ°æ‰“å°å‡ºå½“å‰æœºå™¨1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿçš„**å¹³å‡è´Ÿè½½æ°´å¹³**ã€‚

```bash
$ top -b1
top - 19:27:38 up 18:49,  1 user,  load average: 1.15, 0.72, 0.71
```

è¿™é‡Œ`load average`åŽé¢çš„ä¸‰ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºæœ€è¿‘1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿç³»ç»Ÿçš„å¹³å‡è´Ÿè½½æ°´å¹³ã€‚

é‚£ä¹ˆè¿™ä¸ªæ•°å­—åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿç®€å•çš„è§£é‡Šæ˜¯ï¼Œè¿™ä¸ªæ•°å­—è¶Šå¤§æœºå™¨è¶Šå¿™ã€‚

åœ¨å•æ ¸CPUçš„åœºæ™¯ä¸‹ï¼ŒNode Loadï¼ˆä»¥ä¸‹ç®€ç§°è´Ÿè½½ï¼‰æ˜¯ä¸€ä¸ªéžå¸¸æ ‡å‡†çš„é¥±å’Œåº¦æŒ‡æ ‡ã€‚å¯¹äºŽå•æ ¸CPUï¼Œè´Ÿè½½ä¸º0æ—¶CPUå¤„äºŽå®Œå…¨ç©ºé—²çš„çŠ¶æ€ï¼Œè´Ÿè½½ä¸º1ï¼ˆ100%ï¼‰æ—¶ï¼ŒCPUæ­£å¥½å¤„äºŽæ»¡è½½å·¥ä½œçš„çŠ¶æ€ã€‚è´Ÿè½½å¤§äºŽ100%æ—¶ï¼Œè¶…å‡º100%éƒ¨åˆ†æ¯”ä¾‹çš„ä»»åŠ¡æ­£åœ¨æŽ’é˜Ÿã€‚

Node Loadä¹Ÿæœ‰è‡ªå·±çš„**åˆ©ç”¨çŽ‡ç›®æ ‡**ï¼Œé€šå¸¸çš„ç»éªŒæ˜¯åœ¨å•æ ¸æƒ…å†µä¸‹ï¼š0.7ï¼ˆ70%ï¼‰æ˜¯é»„çº¿ï¼Œæ„å‘³ç€ç³»ç»Ÿæœ‰é—®é¢˜ï¼Œéœ€è¦å°½å¿«æ£€æŸ¥ï¼›1.0ï¼ˆ100%ï¼‰æ˜¯çº¢çº¿ï¼Œè´Ÿè½½å¤§äºŽ1æ„å‘³ç€è¿›ç¨‹å¼€å§‹å †ç§¯ï¼Œéœ€è¦ç«‹å³ç€æ‰‹å¤„ç†ã€‚5.0ï¼ˆ500%ï¼‰æ˜¯æ­»çº¿ï¼Œæ„å‘³ç€ç³»ç»ŸåŸºæœ¬ä¸Šå·²ç»å µæ­»äº†ã€‚

å¯¹äºŽå¤šæ ¸CPUï¼Œäº‹æƒ…ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ã€‚å‡è®¾æœ‰nä¸ªæ ¸ï¼Œé‚£ä¹ˆå½“ç³»ç»Ÿè´Ÿè½½ä¸ºnæ—¶ï¼Œæ‰€æœ‰CPUéƒ½å¤„äºŽæ»¡è½½å·¥ä½œçš„çŠ¶æ€ï¼›è€Œå½“ç³»ç»Ÿè´Ÿè½½ä¸ºn/2æ—¶ï¼Œå§‘ä¸”å¯ä»¥è®¤ä¸ºä¸€åŠCPUæ ¸æ­£åœ¨æ»¡è½½è¿è¡Œã€‚å› è€Œ48æ ¸CPUçš„æœºå™¨æ»¡è½½æ—¶çš„è´Ÿè½½ä¸º48ã€‚æ€»çš„æ¥è¯´ï¼Œå¦‚æžœæˆ‘ä»¬æŠŠæœºå™¨è´Ÿè½½é™¤ä»¥æœºå™¨çš„CPUæ ¸æ•°ï¼Œå¾—åˆ°çš„æŒ‡æ ‡å°±ä¸Žå•æ ¸åœºæ™¯ä¸‹ä¿æŒä¸€è‡´äº†ï¼ˆ0%ç©ºè½½ï¼Œ100%æ»¡è½½ï¼‰ã€‚

### CPUåˆ©ç”¨çŽ‡ï¼ˆCPU Utilizationï¼‰

å¦ä¸€ä¸ªå¾ˆæœ‰å€Ÿé‰´æ„ä¹‰çš„æŒ‡æ ‡æ˜¯**CPUåˆ©ç”¨çŽ‡ï¼ˆCPU Utilizationï¼‰**ã€‚CPUåˆ©ç”¨çŽ‡å…¶å®žæ˜¯é€šè¿‡ä¸€ä¸ªç®€å•çš„å…¬å¼è®¡ç®—å‡ºæ¥çš„ï¼Œå¯¹äºŽå•æ ¸CPUï¼š

```yaml
1 - irate(node_cpu_seconds_total{mode="idle"}[1m]
```

è¿™é‡Œ`node_cpu_seconds_total{mode="idle"}`æ˜¯ä¸€ä¸ªè®¡æ•°å™¨æŒ‡æ ‡ï¼Œè¡¨ç¤ºCPUå¤„äºŽç©ºé—²çŠ¶æ€çš„æ€»æ—¶é•¿ã€‚`irate`å‡½æ•°ä¼šç”¨è¯¥æŒ‡æ ‡å¯¹æ—¶é—´è¿›è¡Œæ±‚å¯¼ï¼Œå¾—å‡ºçš„ç»“æžœæ˜¯ï¼Œæ¯ç§’CPUå¤„äºŽç©ºé—²çŠ¶æ€çš„æ—¶é•¿ï¼Œæ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯CPUç©ºé—²çŽ‡ã€‚ç”¨1å‡åŽ»è¯¥å€¼å°±å¾—åˆ°äº†CPUçš„åˆ©ç”¨çŽ‡ã€‚

 å¯¹äºŽå¤šæ ¸CPUæ¥è¯´ï¼Œåªéœ€è¦æŠŠæ¯ä¸ªCPUæ ¸çš„åˆ©ç”¨çŽ‡åŠ èµ·æ¥ï¼Œé™¤ä»¥CPUçš„æ ¸æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°CPUçš„æ•´ä½“åˆ©ç”¨çŽ‡ã€‚

é‚£ä¹ˆè¿™ä¸¤ä¸ªæŒ‡æ ‡å¯¹äºŽPGçš„è´Ÿè½½åˆæœ‰ä»€ä¹ˆå€Ÿé‰´æ„ä¹‰å‘¢ï¼Ÿ

### æ•°æ®åº“è´Ÿè½½ï¼ˆPG Loadï¼‰

PGçš„è´Ÿè½½æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼äºŽCPUåˆ©ç”¨çŽ‡å’Œæœºå™¨è´Ÿè½½çš„æ–¹å¼æ¥å®šä¹‰ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ªæžæ£’çš„ä¸»æ„ã€‚

è®©æˆ‘ä»¬å…ˆæ¥è€ƒè™‘å•è¿›ç¨‹æƒ…å†µä¸‹çš„PGè´Ÿè½½ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ä¸ªæŒ‡æ ‡ï¼Œå½“è¯¥PGè¿›ç¨‹å®Œå…¨ç©ºé—²æ—¶è´Ÿè½½å› å­ä¸º0ï¼Œå½“è¯¥è¿›ç¨‹å¤„äºŽæ»¡è½½çŠ¶æ€æ—¶è´Ÿè½½ä¸º1ï¼ˆ100%ï¼‰ã€‚ç±»æ¯”CPUåˆ©ç”¨çŽ‡çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨â€œ***å•ä¸ªPGè¿›ç¨‹å¤„äºŽæ´»è·ƒçŠ¶æ€çš„æ—¶é•¿å æ¯”***â€æ¥è¡¨ç¤ºâ€œå•ä¸ªPGåŽç«¯è¿›ç¨‹çš„åˆ©ç”¨çŽ‡â€ã€‚

å¦‚å›¾1æ‰€ç¤ºï¼Œåœ¨ä¸€ç§’çš„ç»Ÿè®¡å‘¨æœŸå†…ï¼ŒPGå¤„äºŽæ´»è·ƒï¼ˆæ‰§è¡ŒæŸ¥è¯¢æˆ–è€…æ‰§è¡Œäº‹åŠ¡ï¼‰çŠ¶æ€çš„æ—¶é•¿ä¸º0.6ç§’ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’å†…çš„PGè´Ÿè½½å°±æ˜¯60%ã€‚å¦‚æžœè¿™ä¸ªå”¯ä¸€çš„PGè¿›ç¨‹åœ¨æ•´ä¸ªç»Ÿè®¡å‘¨æœŸä¸­éƒ½å¤„äºŽå¿™ç¢ŒçŠ¶æ€ï¼Œè€Œä¸”è¿˜æœ‰0.4ç§’çš„ä»»åŠ¡åœ¨æŽ’é˜Ÿï¼Œå¦‚é‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºPGçš„è´Ÿè½½ä¸º140%ã€‚

![](../img/pg-load-fig.png)

å¯¹äºŽå¹¶è¡Œåœºæ™¯ï¼Œè®¡ç®—æ–¹æ³•ä¸Žå¤šæ ¸CPUçš„åˆ©ç”¨çŽ‡ç±»ä¼¼ï¼Œé¦–å…ˆæŠŠæ‰€æœ‰PGè¿›ç¨‹åœ¨ç»Ÿè®¡å‘¨æœŸï¼ˆ1sï¼‰å†…å¤„äºŽæ´»è·ƒçŠ¶æ€çš„æ—¶é•¿ç´¯åŠ ï¼Œç„¶åŽé™¤ä»¥â€œ**å¯ç”¨çš„PGè¿›ç¨‹/è¿žæŽ¥æ•°**â€ï¼Œæˆ–è€…è¯´â€œ**å¯ç”¨å¹¶è¡Œæ•°**â€ï¼Œå³å¯å¾—åˆ°PGæœ¬èº«çš„åˆ©ç”¨çŽ‡æŒ‡æ ‡ï¼Œå¦‚å›¾3æ‰€ç¤ºã€‚ä¸¤ä¸ªPGåŽç«¯è¿›ç¨‹åˆ†åˆ«æœ‰200ms+400msä¸Ž800msçš„æ´»è·ƒæ—¶é•¿ï¼Œé‚£ä¹ˆæ•´ä½“çš„è´Ÿè½½æ°´å¹³ä¸ºï¼š`(0.2s + 0.4s + 0.8s) / 1s / 2 = 70%`

æ€»ç»“ä¸€ä¸‹ï¼ŒæŸä¸€æ®µæ—¶é—´å†…PGçš„è´Ÿè½½å¯ä»¥å®šä¹‰ä¸ºï¼š

`pg_load = pg_active_seconds / time_peroid / parallel  `

* `pg_active_seconds`æ˜¯è¯¥æ—¶é—´æ®µå†…æ‰€æœ‰PGè¿›ç¨‹å¤„äºŽæ´»è·ƒçŠ¶æ€çš„æ—¶é•¿ä¹‹å’Œã€‚

* `time_peroid`æ˜¯è´Ÿè½½è®¡ç®—çš„ç»Ÿè®¡å‘¨æœŸï¼Œé€šå¸¸ä¸º1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿï¼Œä»¥åŠå®žæ—¶ï¼ˆå°äºŽ10ç§’ï¼‰ã€‚
* `parallel `æ˜¯PostgreSQLçš„å¯ç”¨å¹¶è¡Œæ•°ï¼ŒåŽé¢ä¼šè¯¦ç»†è§£é‡Šã€‚

å› ä¸ºå‰ä¸¤é¡¹ä¹‹å•†å®žé™…ä¸Šå°±æ˜¯ä¸€æ®µæ—¶é—´å†…çš„æ¯ç§’æ´»è·ƒæ—¶é•¿æ€»æ•°ï¼Œå› æ­¤è¿™ä¸ªå…¬å¼è¿›ä¸€æ­¥å¯ä»¥ç®€åŒ–ä¸ºæ´»è·ƒæ—¶é•¿å¯¹æ—¶é—´çš„å¯¼æ•°é™¤ä»¥å¯ç”¨å¹¶è¡Œæ•°ï¼Œå³ï¼š

`rate(pg_active_seconds[time_peroid]) / parallel `

`time_peroid`é€šå¸¸æ˜¯å›ºå®šçš„å¸¸é‡ï¼ˆ1ï¼Œ5ï¼Œ15åˆ†é’Ÿï¼‰ï¼Œæ‰€ä»¥é—®é¢˜å°±æ˜¯å¦‚ä½•èŽ·å–PGè¿›ç¨‹æ´»è·ƒæ€»æ—¶é•¿`pg_active_seconds`è¿™ä¸ªæŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•è¯„ä¼°è®¡ç®—æ•°æ®åº“å¯ç”¨å¹¶è¡Œæ•°`max_parallel `äº†ã€‚




------

## 0x04 è®¡ç®—PGçš„è´Ÿè½½é¥±å’Œåº¦

### **äº‹åŠ¡è¿˜æ˜¯æŸ¥è¯¢ï¼Ÿ**

å½“æˆ‘ä»¬è¯´æ•°æ®åº“è¿›ç¨‹ æ´»è·ƒ/ç©ºé—² æ—¶ï¼Œç©¶ç«Ÿåœ¨è¯´ä»€ä¹ˆï¼Ÿ **PGå¤„äºŽæ´»è·ƒçŠ¶æ€ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€**ï¼Ÿå¦‚æžœPGåŽç«¯è¿›ç¨‹æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆå½“ç„¶å¯ä»¥è®¤ä¸ºPGæ­£å¤„äºŽå¿™ç¢ŒçŠ¶æ€ã€‚ä½†å¦‚æžœå¦‚ä¸Šå›¾4æ‰€ç¤ºï¼ŒPGè¿›ç¨‹æ­£åœ¨æ‰§è¡Œä¸€ä¸ªäº¤äº’å¼äº‹åŠ¡ï¼Œä½†æ²¡æœ‰å®žé™…æ‰§è¡ŒæŸ¥è¯¢ï¼Œå³æ‰€è°“çš„â€œIdle in Transactionâ€çŠ¶æ€ï¼Œåˆåº”è¯¥æ€Žä¹ˆè®¡ç®—â€œæ´»è·ƒæ—¶é•¿â€å‘¢ï¼Ÿå›¾4ä¸­ä¸¤ä¸ªæŸ¥è¯¢ä¸­ç©ºé—²çš„é‚£200msæ—¶é—´ã€‚é‚£ä¹ˆè¿™æ®µæ—¶é—´åº”è¯¥ç®—ä½œâ€œæ´»è·ƒâ€ï¼Œè¿˜æ˜¯ç®—ä½œâ€œç©ºé—²â€å‘¢ï¼Ÿ

**è¿™é‡Œçš„æ ¸å¿ƒé—®é¢˜æ˜¯æ€Žä¹ˆå®šä¹‰æ´»è·ƒçŠ¶æ€**ï¼šæ•°æ®åº“è¿›ç¨‹ä½äºŽäº‹åŠ¡ä¸­ç®—æ´»è·ƒï¼Œè¿˜æ˜¯åªæœ‰å½“å®žé™…æ‰§è¡ŒæŸ¥è¯¢æ—¶æ‰ç®—æ´»è·ƒã€‚å¯¹äºŽæ²¡æœ‰äº¤äº’å¼äº‹åŠ¡çš„åœºæ™¯ï¼Œä¸€ä¸ªæŸ¥è¯¢å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç”¨å“ªç§æ–¹å¼éƒ½ä¸€æ ·ï¼Œä½†å¯¹äºŽå¤šè¯­å¥ï¼Œç‰¹åˆ«æ˜¯äº¤äº’å¼çš„å¤šè¯­å¥äº‹åŠ¡ï¼Œè¿™ä¸¤è€…å°±æœ‰æ¯”è¾ƒæ˜Žæ˜¾çš„åŒºåˆ«äº†ã€‚ä»Žèµ„æºä½¿ç”¨çš„è§’åº¦çœ‹ï¼Œæ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢ä¹Ÿå°±æ„å‘³ç€æ²¡æœ‰æ¶ˆè€—æ•°æ®åº“æœ¬èº«çš„èµ„æºã€‚ä½†ç©ºé—²ç€çš„äº‹åŠ¡æœ¬èº«ä¼šå ç”¨è¿žæŽ¥å¯¼è‡´è¿žæŽ¥æ— æ³•å¤ç”¨ï¼ŒIdle In Transactionæœ¬èº«ä¹Ÿåº”å½“æ˜¯ä¸€ç§æžåŠ›é¿å…çš„æƒ…å†µã€‚æ€»çš„æ¥è¯´ï¼Œè¿™ä¸¤ç§å®šä¹‰æ–¹å¼éƒ½å¯ä»¥ï¼Œä½¿ç”¨äº‹åŠ¡çš„æ–¹å¼ä¼šç•¥å¾®é«˜ä¼°åº”ç”¨è´Ÿè½½ï¼Œä½†ä»Žè´Ÿè½½è¯„ä¼°çš„è§’åº¦å¯èƒ½ä¼šæ›´ä¸ºåˆé€‚ã€‚

### **å¦‚ä½•èŽ·å–æ´»è·ƒæ—¶é•¿**

å†³å®šäº†æ•°æ®åº“åŽç«¯è¿›ç¨‹çš„æ´»è·ƒå®šä¹‰åŽï¼Œç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•èŽ·å–ä¸€æ®µæ—¶é—´çš„æ•°æ®åº“æ´»è·ƒæ—¶é•¿ï¼Ÿä¸å¹¸çš„æ˜¯åœ¨PGä¸­ï¼Œç”¨æˆ·å¾ˆéš¾é€šè¿‡æ•°æ®åº“æœ¬èº«èŽ·å–è¿™ä¸€æ€§èƒ½æŒ‡æ ‡ã€‚PGæä¾›äº†ä¸€ä¸ªç³»ç»Ÿè§†å›¾ï¼š`pg_stat_activity`ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰è¿è¡Œç€çš„Postgresè¿›ç¨‹é‡Œåˆ—è¡¨ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹å¿«ç…§ï¼Œåªèƒ½å¤§è‡´å‘Šè¯‰åœ¨å½“å‰æ—¶åˆ»ï¼Œæ•°æ®åº“çš„åŽç«¯è¿›ç¨‹ä¸­æœ‰å¤šå°‘ä¸ªå¤„äºŽæ´»è·ƒçŠ¶æ€ï¼Œæœ‰å¤šå°‘ä¸ªå¤„äºŽç©ºé—²çŠ¶æ€ã€‚ç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æ•°æ®åº“å¤„äºŽæ´»è·ƒçŠ¶æ€çš„æ—¶é•¿ï¼Œå°±æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç±»ä¼¼äºŽLoadçš„è®¡ç®—æ–¹å¼ï¼Œé€šè¿‡å‘¨æœŸæ€§åœ°é‡‡æ ·PGä¸­æ´»è·ƒè¿›ç¨‹çš„æ•°é‡ï¼Œè®¡ç®—å‡ºä¸€ä¸ªè´Ÿè½½æŒ‡æ ‡æ¥ã€‚ä¸è¿‡ï¼Œè¿™é‡Œæœ‰æ›´å¥½çš„åŠžæ³•ï¼Œä½†æ˜¯éœ€è¦ä¸­é—´ä»¶çš„ååŠ©å‚ä¸Žã€‚

æ•°æ®åº“ä¸­é—´ä»¶å¯¹äºŽæ€§èƒ½ç›‘æŽ§éžå¸¸é‡è¦ï¼Œå› ä¸ºå¾ˆå¤šæŒ‡æ ‡æ•°æ®åº“æœ¬èº«å¹¶æ²¡æœ‰æä¾›ï¼Œåªæœ‰é€šè¿‡ä¸­é—´ä»¶æ‰èƒ½æš´éœ²å‡ºæ¥ã€‚ä»¥Pgbouncerä¸ºä¾‹ï¼ŒPgbounceråœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ç³»åˆ—ç»Ÿè®¡è®¡æ•°å™¨ï¼Œä½¿ç”¨`SHOW STATS`å¯ä»¥æ‰“å°å‡ºè¿™äº›æŒ‡æ ‡ï¼Œè¯¸å¦‚ï¼š

- total_xact_countï¼šæ€»å…±æ‰§è¡Œäº†å¤šå°‘ä¸ªäº‹åŠ¡
- total_query_countï¼šæ€»å…±æ‰§è¡Œäº†å¤šå°‘ä¸ªæŸ¥è¯¢
- total_xact_timeï¼šæ€»å…±èŠ±è´¹åœ¨äº‹åŠ¡æ‰§è¡Œçš„æ—¶é•¿
- total_query_timeï¼šæ€»å…±èŠ±è´¹åœ¨æŸ¥è¯¢æ‰§è¡Œä¸Šçš„æ—¶é•¿

è¿™é‡Œ`total_xact_time`å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œå®ƒè®°å½•äº†Pgbouncerä¸­é—´ä»¶ä¸­èŠ±è´¹åœ¨æŸä¸ªæ•°æ®åº“ä¸Šçš„äº‹åŠ¡æ€»è€—æ—¶ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨è¿™ä¸ªæŒ‡æ ‡å¯¹æ—¶é—´æ±‚å¯¼ï¼Œå°±å¯ä»¥å¾—åˆ°æƒ³è¦çš„æ•°æ®ï¼šæ¯ç§’æ´»è·ƒæ—¶é•¿å æ¯”ã€‚

è¿™é‡Œä½¿ç”¨Prometheusçš„PromQLè¡¨è¾¾è®¡ç®—é€»è¾‘ï¼Œé¦–å…ˆå¯¹äº‹åŠ¡è€—æ—¶è®¡æ•°å™¨æ±‚å¯¼ï¼Œåˆ†åˆ«ç®—å‡ºå…¶1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿï¼Œä»¥åŠå®žæ—¶ç²’åº¦ï¼ˆæœ€è¿‘ä¸¤æ¬¡é‡‡æ ·ç‚¹ä¹‹é—´ï¼‰ä¸Šçš„**æ¯ç§’æ´»è·ƒæ—¶é•¿**ã€‚å†ä¸Šå·æ±‚å’Œï¼Œå°†æ•°æ®åº“å±‚æ¬¡çš„æŒ‡æ ‡ä¸Šå·ä¸ºå®žä¾‹çº§åˆ«çš„æŒ‡æ ‡ã€‚ï¼ˆè¿žæŽ¥æ± `SHOW STATS`è¿™é‡Œçš„ç»Ÿè®¡æŒ‡æ ‡æ˜¯ä»¥æ•°æ®åº“ä¸ºå•ä½çš„ï¼Œå› æ­¤åœ¨è®¡ç®—å®žä¾‹çº§åˆ«çš„æ€»æ´»è·ƒæ—¶é•¿æ—¶ï¼Œåº”å½“ä¸Šå·æ±‚å’Œï¼Œæ¶ˆé™¤æ•°æ®åº“ç»´åº¦çš„æ ‡ç­¾ï¼š`sum without(datname)`ï¼‰

```yaml
- record: pg:ins:xact_time_realtime
expr: sum without (datname) (irate(pgbouncer_stat_total_xact_time{}[1m]))
- record: pg:ins:xact_time_rate1m
expr: sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[1m]))
- record: pg:ins:xact_time_rate5m
expr: sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[5m]))
- record: pg:ins:xact_time_rate15m
expr: sum without (datname) (rate(pgbouncer_stat_total_xact_time{}[15m]))
```

è¿™æ ·è®¡ç®—å¾—åˆ°çš„ç»“æžœæŒ‡æ ‡å·²ç»å¯ä»¥ç›¸å¯¹æœ¬èº«è¿›è¡Œçºµå‘æ¯”è¾ƒï¼Œå¹¶åœ¨åŒæ ·è§„æ ¼çš„å®žä¾‹é—´è¿›è¡Œæ¨ªå‘æ¯”è¾ƒäº†ã€‚è€Œä¸”æ— è®ºæ•°æ®åº“çš„è´Ÿè½½ç±»åž‹æ€Žæ ·ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‡æ ‡ã€‚

ä¸è¿‡**ä¸åŒè§„æ ¼çš„å®žä¾‹ï¼Œä»ç„¶æ²¡æ³•ä½¿ç”¨è¿™ä¸ªæŒ‡æ ‡è¿›è¡Œå¯¹æ¯”**ã€‚æ¯”å¦‚å¯¹äºŽå•æ ¸å•è¿žæŽ¥PGï¼Œæ»¡è½½æ—¶æ¯ç§’æ´»è·ƒæ—¶é•¿å¯èƒ½æ˜¯1ç§’ï¼Œä¹Ÿå°±æ˜¯100%åˆ©ç”¨çŽ‡ã€‚è€Œå¯¹äºŽ64æ ¸64è¿žæŽ¥çš„PGï¼Œæ»¡è½½æ—¶æ¯ç§’æ´»è·ƒæ—¶é•¿æ˜¯64ç§’ï¼Œé‚£ä¹ˆå°±æ˜¯6400%çš„åˆ©ç”¨çŽ‡ã€‚å› æ­¤ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå½’ä¸€åŒ–çš„å¤„ç†ï¼Œé‚£ä¹ˆé—®é¢˜åˆæ¥äº†ã€‚

### å¯ç”¨å¹¶è¡Œæ•°å¦‚ä½•å®šä¹‰ï¼Ÿ

ä¸åŒäºŽCPUåˆ©ç”¨çŽ‡ï¼ŒPGçš„å¯ç”¨å¹¶è¡Œæ•°å¹¶æ²¡æœ‰ä¸€ä¸ªæ¸…æ™°çš„å®šä¹‰ï¼Œè€Œä¸”è·Ÿè´Ÿè½½ç±»åž‹æœ‰ä¸€äº›å¾®å¦™çš„å…³ç³»ã€‚ä½†èƒ½å¤Ÿç¡®å®šçš„æ˜¯ï¼Œåœ¨ä¸€å®šèŒƒå›´å†…ï¼Œ**æœ€å¤§å¯ç”¨å¹¶è¡Œä¸ŽCPUçš„æ ¸æ•°å‘ˆç²—ç•¥çš„çº¿æ€§å…³ç³»**ã€‚å½“ç„¶è¿™ä¸ªç»“è®ºçš„å‰ææ˜¯æ•°æ®åº“æœ€å¤§è¿žæŽ¥æ•°æ˜¾è‘—è¶…è¿‡CPUæ ¸æ•°ï¼Œå¦‚æžœåœ¨64æ ¸çš„CPUä¸Šåªå…è®¸æ•°æ®åº“å»ºç«‹30æ¡è¿žæŽ¥ï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®šæœ€å¤§å¯ç”¨å¹¶è¡Œå°±æ˜¯30è€Œä¸æ˜¯CPUæ ¸æ•°64ã€‚è½¯ä»¶çš„å¹¶è¡Œæœ€ç»ˆè¿˜æ˜¯è¦ç”±ç¡¬ä»¶çš„å¹¶è¡Œåº¦æ¥æ”¯æ’‘ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç®€å•çš„ä½¿ç”¨å®žä¾‹çš„CPUæ ¸æ•°ä½œä¸ºå¯ç”¨å¹¶è¡Œæ•°ã€‚

åœ¨64æ ¸çš„CPUä¸Šè¿è¡Œ64ä¸ªæ´»è·ƒPGè¿›ç¨‹ï¼Œåˆ™å…¶è´Ÿè½½ä¸ºï¼ˆ6400% / 64 = 100%ï¼‰ã€‚åŒç†è¿è¡Œ128ä¸ªæ´»è·ƒPGè¿›ç¨‹ï¼Œè´Ÿè½½å°±æ˜¯ï¼ˆ12800% / 64 = 200%ï¼‰ã€‚

é‚£ä¹ˆåˆ©ç”¨ä¸Šé¢è®¡ç®—å¾—åˆ°çš„æ¯ç§’æ´»è·ƒæ—¶é•¿æŒ‡æ ‡ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºå®žä¾‹çº§åˆ«çš„PGè´Ÿè½½æŒ‡æ•°äº†ã€‚

```yaml
- record: pg:ins:load0
expr:  pg:ins:xact_time_realtime / on (ip) group_left()  node:ins:cpu_count
- record: pg:ins:load1
expr: pg:ins:xact_time_rate1m  / on (ip) group_left()  node:ins:cpu_count
- record: pg:ins:load5
expr: pg:ins:xact_time_rate5m  / on (ip) group_left()  node:ins:cpu_count
- record: pg:ins:load15
expr: pg:ins:xact_time_rate15m  / on (ip) group_left()  node:ins:cpu_count
```

### PG LOADçš„å¦ä¸€ç§è§£é‡Š

å¦‚æžœæˆ‘ä»¬ä»”ç»†å®¡è§†PG Loadçš„å®šä¹‰ï¼Œå…¶å®žå¯ä»¥å‘çŽ°æ¯ç§’æ´»è·ƒæ—¶é•¿è¿™ä¸ªæŒ‡æ ‡ï¼Œå…¶å®žå¯ä»¥ç²—ç•¥ç­‰ä»·äºŽï¼šTPS x XactRTï¼Œæˆ–è€…QPS x Query RTã€‚è¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå‡è®¾æˆ‘QPSä¸º1000ï¼Œæ¯ä¸ªæŸ¥è¯¢RTä¸º1msï¼Œåˆ™æ¯ç§’èŠ±è´¹åœ¨æŸ¥è¯¢ä¸Šçš„æ—¶é—´ä¸º 1000 * 1ms = 1sã€‚

å› æ­¤ï¼ŒPG Loadå¯ä»¥è§†ä¸ºä¸€ä¸ªç”±ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡å¤åˆè€Œæˆçš„è¡ç”ŸæŒ‡æ ‡ï¼š`tps * xact_rt /  cpu_count`

TPSï¼ŒRTç”¨äºŽè´Ÿè½½è¯„ä¼°éƒ½æœ‰å„è‡ªçš„é—®é¢˜ï¼Œä½†å®ƒä»¬é€šè¿‡ç®€å•çš„ä¹˜æ³•ç»“åˆæˆä¸€ä¸ªæ–°çš„å¤åˆæŒ‡æ ‡ï¼Œä¸€ä¸‹å­å°±æ˜¾ç¤ºå‡ºäº†ç¥žå¥‡çš„åŠ›é‡ã€‚ï¼ˆå°½ç®¡å®žé™…ä¸Šæ˜¯é€šè¿‡å…¶ä»–æ›´å‡†ç¡®çš„æ–¹å¼è®¡ç®—å‡ºæ¥çš„ï¼‰




------

## 0x05 PG Loadçš„å®žé™…æ•ˆæžœ

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹PG Loadç”¨äºŽå®žé™…ç”Ÿäº§çŽ¯å¢ƒçš„è¡¨çŽ°ã€‚

PG Loadæœ€ç›´æŽ¥çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œå‘Šè­¦ä»¥åŠå®¹é‡è¯„ä¼°ã€‚

### Case 1: ç”¨äºŽæŠ¥è­¦ï¼šæ…¢æŸ¥è¯¢å †ç§¯å¯¼è‡´çš„æœåŠ¡ä¸å¯ç”¨

ä¸‹å›¾æ˜¯ä¸€æ¬¡ç”Ÿäº§äº‹æ•…çš„çŽ°åœºï¼Œç”±äºŽæŸä¸šåŠ¡ä¸Šçº¿äº†ä¸€ä¸ªæ…¢æŸ¥è¯¢ï¼Œçž¬é—´å¯¼è‡´è¿žæŽ¥æ± è¢«æ…¢æŸ¥è¯¢å æ®ï¼Œå‘ç”Ÿå †ç§¯ã€‚å¯ä»¥çœ‹å‡ºPG Loadå’ŒRTéƒ½å¾ˆåŠæ—¶åœ°åæ˜ å‡ºäº†æ•…éšœçš„æƒ…å†µï¼Œè€ŒTPSçœ‹ä¸ŠåŽ»åˆ™æ˜¯æŽ‰äº†ä¸€ä¸ªå‘ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«æ˜¾çœ¼ã€‚

ä»Žæ•ˆæžœä¸Šçœ‹ï¼ŒPG Load1ä¸ŽPG Load0ï¼ˆå®žæ—¶è´Ÿè½½ï¼‰æ˜¯ä¸€ä¸ªç›¸å½“çµæ•çš„æŒ‡æ ‡ï¼Œå¯¹äºŽå¤§å¤šæ•°ä¸ŽåŽ‹åŠ›è´Ÿè½½æœ‰å…³çš„æ•…éšœéƒ½èƒ½åŠæ—¶å‡†ç¡®ä½œå‡ºååº”ã€‚æ‰€ä»¥è¢«æˆ‘ä»¬é‡‡çº³ä¸ºæ ¸å¿ƒæŠ¥è­¦æŒ‡æ ‡ã€‚

PG Loadçš„åˆ©ç”¨çŽ‡ç›®æ ‡æœ‰ä¸€äº›ç»éªŒå€¼ï¼šé»„çº¿é€šå¸¸ä¸º50%ï¼Œå³éœ€è¦å¼•èµ·å…³æ³¨çš„é˜ˆå€¼ï¼›çº¢çº¿é€šå¸¸ä¸º70%ï¼Œå³æŠ¥è­¦çº¿ï¼Œéœ€è¦ç«‹åˆ»é‡‡å–è¡ŒåŠ¨çš„é˜ˆå€¼ï¼›500%æˆ–æ›´é«˜é€šå¸¸æ„å‘³ç€è¿™ä¸ªå®žä¾‹å·²ç»è¢«æ‰“å´©äº†ã€‚

![](pg-load-compare.png)

### Case 2ï¼šç”¨äºŽæ°´ä½è¯„ä¼°ä¸Žå®¹é‡è§„åˆ’

æ¯”èµ·æŠ¥è­¦ï¼Œæ°´ä½è¯„ä¼°ä¸Žå®¹é‡è§„åˆ’æ›´åƒæ˜¯PG Loadçš„æ ¸å¿ƒç”¨é€”ã€‚æ¯•ç«ŸæŠ¥è­¦ä¹‹ç±»çš„çš„éœ€æ±‚è¿˜æ˜¯å¯ä»¥é€šè¿‡å»¶è¿Ÿï¼ŒæŽ’é˜Ÿè¿žæŽ¥ç­‰æŒ‡æ ‡æ¥æ»¡è¶³çš„ã€‚

è¿™é‡Œï¼ŒPGé›†ç¾¤çš„15åˆ†é’Ÿè´Ÿè½½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å‚è€ƒå€¼ã€‚é€šè¿‡è¿™ä¸ªæŒ‡æ ‡çš„åŽ†å²å‡å€¼ï¼Œå³°å€¼ï¼Œä»¥åŠå…¶ä»–ä¸€äº›ç»Ÿè®¡é‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾åœ°çœ‹å‡ºå“ªäº›é›†ç¾¤å¤„äºŽé«˜è´Ÿè½½çŠ¶æ€éœ€è¦æ‰©å®¹ï¼Œå“ªäº›é›†ç¾¤å¤„äºŽä½Žèµ„æºåˆ©ç”¨çŽ‡çŠ¶æ€éœ€è¦ç¼©å®¹ã€‚

CPUåˆ©ç”¨çŽ‡æ˜¯å¦ä¸€ä¸ªå¾ˆé‡è¦çš„å®¹é‡è¯„ä¼°æŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒPG Loadä¸ŽCPU Usageæœ‰ç€å¾ˆå¯†åˆ‡çš„å…³ç³»ã€‚ä¸è¿‡ç›¸æ¯”CPUä½¿ç”¨çŽ‡ï¼ŒPG Loadæ›´ä¸ºçº¯ç²¹åœ°åæ˜ äº†æ•°æ®åº“æœ¬èº«çš„è´Ÿè½½æ°´å¹³ï¼Œæ»¤é™¤äº†æœºå™¨ä¸Šçš„æ— å…³è´Ÿè½½ï¼Œä¹Ÿå¯ä»¥æ»¤é™¤æŽ‰æ•°æ®åº“ç»´æŠ¤å·¥ä½œï¼ˆå¤‡ä»½ï¼Œæ¸…ç†ï¼Œåžƒåœ¾å›žæ”¶ï¼‰äº§ç”Ÿçš„æ‚éŸ³ï¼Œæ›´ä¸ºä¸æ»‘å¹³é¡ºã€‚å› æ­¤éžå¸¸é€‚åˆç”¨äºŽå®¹é‡è¯„ä¼°ã€‚

å½“ç³»ç»Ÿè´Ÿè½½é•¿æœŸä½äºŽ30%~50%æ—¶ï¼Œå°±åº”è¯¥è€ƒè™‘è¿›è¡Œæ‰©å®¹äº†ã€‚

![](pg-load-cluster.png)





------

## 0x06 ç»“è®º

æœ¬æ–‡ä»‹ç»äº†ä¸€ç§å®šé‡è¡¡é‡PGè´Ÿè½½çš„æ–¹å¼ï¼Œå³PG LoadæŒ‡æ ‡

è¯¥æŒ‡æ ‡å¯ä»¥ç®€å•ç›´è§‚åœ°åæ˜ æ•°æ®åº“å®žä¾‹çš„è´Ÿè½½æ°´å¹³

è¯¥æŒ‡æ ‡éžå¸¸é€‚åˆä½œå®¹é‡è¯„ä¼°ä¹‹ç”¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ ¸å¿ƒæŠ¥è­¦æŒ‡æ ‡ã€‚

è¯¥æŒ‡æ ‡å¯ä»¥åŸºæœ¬æ— è§†è´Ÿè½½ç±»åž‹ä¸Žæœºå™¨ç±»åž‹ï¼Œè¿›è¡Œçºµå‘åŽ†å²æ¯”è¾ƒä¸Žæ¨ªå‘æ°´ä½æ¯”è¾ƒã€‚

è¯¥æŒ‡æ ‡å¯ä»¥é€šè¿‡ç®€å•çš„æ–¹å¼è®¡ç®—å¾—å‡ºï¼Œå³æ¯ç§’åŽç«¯è¿›ç¨‹æ´»è·ƒæ€»æ—¶é•¿é™¤ä»¥å¯ç”¨å¹¶å‘æ•°ã€‚

è¯¥æŒ‡æ ‡æ‰€éœ€æ•°æ®éœ€è¦ä»Žæ•°æ®åº“ä¸­é—´ä»¶èŽ·å–

PG Loadçš„0ä»£è¡¨ç©ºè½½ï¼Œ100%ä»£è¡¨æ»¡è½½ã€‚é»„çº¿ç»éªŒå€¼ä¸º50%ï¼Œçº¢çº¿ç»éªŒå€¼ä¸º70%ï¼Œ

PG Loadæ˜¯ä¸€ä¸ªå¥½æŒ‡æ ‡ðŸ‘


> [WeChat Column](https://mp.weixin.qq.com/s/bG6KG7mmu4K7JMYMI34zCQ)